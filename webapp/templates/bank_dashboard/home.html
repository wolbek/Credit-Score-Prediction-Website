{% extends 'dashboard_base.html' %}

{% block title %}Bank Dashboard Page{% endblock %}

{% block links %}
<link href="{{ url_for('static', filename='css/bank_dashboard/home.css') }}" rel="stylesheet"/>
{% endblock %} 

{% block content %}

<main>
    <div class="recent-grid-bank-home">

        {% if exp_loss %}

        <div id="output-bank-cards">
            <div class="card-single">
                <div>
                    <h1>$ {{ '{:,.2f}'.format(exp_loss | round(2))}}</h1>
                    <span>Expected Loss Amount</span>
                </div>
                <div>
                    <span class="las la-balance-scale-right"></span>
                </div>
            </div>
            <div class="card-single">
                <div>
                    <h1>$ {{ '{:,.2f}'.format(fund_amt | round(2))}}</h1>
                    <span>Funded Amount</span>
                </div>
                <div>
                    <span class="las la-money-bill-wave"></span>
                </div>
            </div>
            <div class="card-single">
                <div>
                    <h1>{{exp_loss_perc | round(2)}} %</h1>
                    <span>Expected Loss Percentage</span>
                </div>
                <div>
                    <span class="las la-wallet"></span>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bank-tabs-container">
            <div class="tab_box">
                <button class="tab_btn active">CSV Visualization</button>
                <button class="tab_btn">Model Evaluation Charts</button>
                <button class="tab_btn">Model Evaluation Tables</button>
            </div>
            <div class="content_box">

                <div class="content active">
                    <h2>CSV Visualization</h2>
                    <div id="all-csv-charts">
                        <div id="grade" class="chart"></div>
                        <div id="home-ownership" class="chart"></div>
                        <div id="verification-status" class="chart"></div>
                        <div id="purpose" class="chart"></div>
                        <div id="initial-list-status" class="chart"></div>
                    </div>
                </div>

                <div class="content">
                    <h2>Model Evaluation Charts</h2>
                    <div id="all-charts">
                        <div id="model-evaluation-chart"></div>
                        <div id="actual-predicted-chart" class="chart"></div>
                        <div id="recovery-rate-chart" class="chart"></div>
                        <div id="ccf-chart" class="chart"></div>
                        <div id="roc-chart" class="chart"></div>
                        <div id="gini-chart" class="chart"></div>
                        <div id="smirnov-chart" class="chart"></div>
                    </div>
                </div>
                
                <div class="content">
                    <h2>Model Evaluation Tables</h2>
                    <div id="all-classifier-tables">
                        <table id="pd-classifier-models-comparison">
                            <caption>PD Classifier Models Comparison</caption>
                            <thead>
                                <tr>
                                    <td>Model</td>
                                    <td>Fscore</td>
                                    <td>Recall</td>
                                    <td>Accuracy</td>
                                    <td>Precision</td>
                                    <!-- <td>AUC</td> -->
                                    <td>Xscore</td>
                                </tr>
                            </thead>
                            <tbody>
                                {% for model in all_tables_data['pd_classifier_models_comparison'] %}
                                <tr>
                                    <td>{{model}}</td>
                                    <td>{{all_tables_data['pd_classifier_models_comparison'][model][0]}}</td>
                                    <td>{{all_tables_data['pd_classifier_models_comparison'][model][1]}}</td>
                                    <td>{{all_tables_data['pd_classifier_models_comparison'][model][2]}}</td>
                                    <td>{{all_tables_data['pd_classifier_models_comparison'][model][3]}}</td>
                                    <!-- <td>{{all_tables_data['pd_classifier_models_comparison'][model][4]}}</td> -->
                                    <td>{{all_tables_data['pd_classifier_models_comparison'][model][5]}}</td>
                                </tr>
                                {% endfor %}
                                
                            </tbody>
                        </table>
            
                        <table id="lgd-stage1-classifier-models-comparison">
                            <caption>LGD Stage 1 Classifier Models Comparison Table</caption>
                            <thead>
                                <tr>
                                    <td>Model</td>
                                    <td>Fscore</td>
                                    <td>Recall</td>
                                    <td>Accuracy</td>
                                    <td>Precision</td>
                                    <!-- <td>AUC</td> -->
                                    <td>Xscore</td>
                                </tr>
                            </thead>
                            <tbody>
                                {% for model in all_tables_data['lgd_stage1_classifier_models_comparison'] %}
                                <tr>
                                    <td>{{model}}</td>
                                    <td>{{all_tables_data['lgd_stage1_classifier_models_comparison'][model][0]}}</td>
                                    <td>{{all_tables_data['lgd_stage1_classifier_models_comparison'][model][1]}}</td>
                                    <td>{{all_tables_data['lgd_stage1_classifier_models_comparison'][model][2]}}</td>
                                    <td>{{all_tables_data['lgd_stage1_classifier_models_comparison'][model][3]}}</td>
                                    <!-- <td>{{all_tables_data['lgd_stage1_classifier_models_comparison'][model][4]}}</td> -->
                                    <td>{{all_tables_data['lgd_stage1_classifier_models_comparison'][model][5]}}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div id="all-regressor-tables">
                        <table id="lgd-stage2-regressor-models-comparison">
                            <caption>LGD Stage2 Regressor Models Comparison Table</caption>
                            <thead>
                                <tr>
                                    <td>Model</td>
                                    <td>R2 score</td>
                                    <td>MAE</td>
                                    <td>Explained variance score</td>
                                    <td>RMSE</td>
                                    <td>Mean squared log error</td>
                                    <!-- <td>Median absolute error</td>
                                    <td>Mean poisson deviance</td>
                                    <td>Mean gamma deviance</td>
                                    <td>D2 pinball score</td>
                                    <td>D2 tweedie score</td> -->
                                </tr>
                            </thead>
                            <tbody>
                                {% for model in all_tables_data['lgd_stage2_regressor_models_comparison'] %}
                                <tr>
                                    <td>{{model}}</td>
                                    <td>{{all_tables_data['lgd_stage2_regressor_models_comparison'][model][0]}}</td>
                                    <td>{{all_tables_data['lgd_stage2_regressor_models_comparison'][model][1]}}</td>
                                    <td>{{all_tables_data['lgd_stage2_regressor_models_comparison'][model][2]}}</td>
                                    <td>{{all_tables_data['lgd_stage2_regressor_models_comparison'][model][3]}}</td>
                                    <td>{{all_tables_data['lgd_stage2_regressor_models_comparison'][model][4]}}</td>
                                    <!-- <td>{{all_tables_data['lgd_stage2_regressor_models_comparison'][model][5]}}</td>
                                    <td>{{all_tables_data['lgd_stage2_regressor_models_comparison'][model][6]}}</td>
                                    <td>{{all_tables_data['lgd_stage2_regressor_models_comparison'][model][7]}}</td>
                                    <td>{{all_tables_data['lgd_stage2_regressor_models_comparison'][model][8]}}</td>
                                    <td>{{all_tables_data['lgd_stage2_regressor_models_comparison'][model][9]}}</td> -->
                                </tr>
                                {% endfor %}
                                
                            </tbody>
                        </table>
            
                        <table id="ead-regressor-models-comparison">
                            <caption>EAD Regressor Models Comparison Table</caption>
                            <thead>
                                <tr>
                                    <td>Model</td>
                                    <td>R2 score</td>
                                    <td>MAE</td>
                                    <td>Explained variance score</td>
                                    <td>RMSE</td>
                                    <td>Mean squared log error</td>
                                    <!-- <td>Median absolute error</td>
                                    <td>Mean poisson deviance</td>
                                    <td>Mean gamma deviance</td>
                                    <td>D2 pinball score</td>
                                    <td>D2 tweedie score</td> -->
                                </tr>
                            </thead>
                            <tbody>
                                {% for model in all_tables_data['ead_regressor_models_comparison'] %}
                                <tr>
                                    <td>{{model}}</td>
                                    <td>{{all_tables_data['ead_regressor_models_comparison'][model][0]}}</td>
                                    <td>{{all_tables_data['ead_regressor_models_comparison'][model][1]}}</td>
                                    <td>{{all_tables_data['ead_regressor_models_comparison'][model][2]}}</td>
                                    <td>{{all_tables_data['ead_regressor_models_comparison'][model][3]}}</td>
                                    <td>{{all_tables_data['ead_regressor_models_comparison'][model][4]}}</td>
                                    <!-- <td>{{all_tables_data['ead_regressor_models_comparison'][model][5]}}</td>
                                    <td>{{all_tables_data['ead_regressor_models_comparison'][model][6]}}</td>
                                    <td>{{all_tables_data['ead_regressor_models_comparison'][model][7]}}</td>
                                    <td>{{all_tables_data['ead_regressor_models_comparison'][model][8]}}</td>
                                    <td>{{all_tables_data['ead_regressor_models_comparison'][model][9]}}</td> -->
                                </tr>
                                {% endfor %}
                                
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        {% else %}

        <form id="csv-input-form" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <div>
                <div>Upload old file: &nbsp;<input type="file" accept=".csv" name="csv-file-train" id="csv-file-train" class="upload-btn"/></div>
                <br>
                <div id="not-filled-msg">The uploaded file should contain the following columns: </div>
            </div>
            <br>
            <div>
                <div>Upload file to predict on: &nbsp; <input type="file" accept=".csv" name="csv-file-test" id="csv-file-test" class="upload-btn"/></div>
                <br>
                <div id="not-filled-msg">The uploaded file should contain the following columns: </div>
            </div>
             <br>
            <button type="submit">Submit</button>
        </form>
        <div id="loading-div" class="center hide" >
            <div class="ring"></div>
            <span>loading ...</span>
        </div>

        {% endif %}
    
        
    </div>
</main>

<script>

    // Remove any other active menu. Active the dashboard menu. Change text at top to Dashboard
    $("a").removeClass("active");
    $("#dashboard").addClass("active");
    $("#page").text("Dashboard");
    // json.dumps is compulsory or else the object starts with " and at first property starting with ", it'll get closed.
    // So json.dumps convert " to &#34; 

    const tabs = document.querySelectorAll('.tab_btn');
    const all_content = document.querySelectorAll('.content');

    tabs.forEach((tab,index)=>{
        tab.addEventListener('click', (e)=>{
            tabs.forEach(tab=>{tab.classList.remove('active')});
            tab.classList.add('active');

            var line=document.querySelector('.line');
            all_content.forEach(content=>{content.classList.remove('active')});
            all_content[index].classList.add('active');
        })
    })

    $("#csv-input-form").submit(function(event){
        event.preventDefault();
        // $("#csv-input-form button").attr('disabled', true);
        // $("#csv-file-train").attr('disabled', true);
        // $("#csv-file-test").attr('disabled', true);
        $("#csv-input-form").css("display","none")
        $("#loading-div").removeClass('hide');
        this.submit();
    })

    let data=[];

    $(document).ready(function() {
       
    "{% if all_charts_data %}"

    let all_charts_data = JSON.parse({{all_charts_data | tojson }});
    let all_csv_charts_data = JSON.parse({{all_csv_charts_data | tojson }});

    console.log(all_charts_data)
    console.log(all_csv_charts_data)
    
    // Chart: Grade
    
    data = [{
        labels: all_csv_charts_data['grade']['type'],
        values: all_csv_charts_data['grade']['count'],
        type: 'pie',
        marker: {
            colors: ['#0B6623', '#708238', '#29AB87', '#004B49', '#1C352D', '#1A2421', '#46a370']
        },
        textfont: {
            color: 'white'
        }
    }];

    layout = {
        title: 'Grade Distribution',
        width: 700,
        height: 500,
    };

    Plotly.newPlot('grade', data, layout);

    // Chart: Home Ownership
    
    data = [{
        labels: all_csv_charts_data['home_ownership']['type'],
        values: all_csv_charts_data['home_ownership']['count'],
        type: 'pie',
        marker: {
            colors: ['#0B6623', '#708238', '#29AB87', '#004B49', '#1C352D']
        },
        textfont: {
            color: 'white'
        }
    }];

    layout = {
        title: 'Home Ownership Distribution',
        width: 700,
        height: 500,
    };

    Plotly.newPlot('home-ownership', data, layout);

    // Chart: Verification Status
    
    data = [{
        labels: all_csv_charts_data['verification_status']['type'],
        values: all_csv_charts_data['verification_status']['count'],
        type: 'pie',
        marker: {
            colors: ['#0B6623', '#708238','#29AB87']
        },
        textfont: {
            color: 'white'
        }
    }];

    layout = {
        title: 'Verification Status Distribution',
        width: 700,
        height: 500,
    };

    Plotly.newPlot('verification-status', data, layout);

    // Chart: Purpose
    
    data = [{
        labels: all_csv_charts_data['purpose']['type'],
        values: all_csv_charts_data['purpose']['count'],
        type: 'pie',
        marker: {
            colors: ['#0B6623', '#708238', '#29AB87', '#004B49', '#1C352D', '#1A2421', '#46a370', '#042412', '#304a3b', '#14c760', '#00170a', '#0b6b51','#104738','#79dba4']
        },
        textfont: {
            color: 'white'
        }

    }];

    layout = {
        title: 'Purpose Distribution',
        width: 700,
        height: 500,
    };

    Plotly.newPlot('purpose', data, layout);

    // Chart: Initial list status
    
    data = [{
        labels: all_csv_charts_data['initial_list_status']['type'],
        values: all_csv_charts_data['initial_list_status']['count'],
        type: 'pie',
        marker: {
            colors: ['#0B6623', '#708238']
        },
        textfont: {
            color: 'white'
        }
    }];

    layout = {
        title: 'Initial List Status Distribution',
        width: 700,
        height: 500,
    };

    Plotly.newPlot('initial-list-status', data, layout);

    data=[]
    // Chart: Model evaluation Data

    let algos = Object.keys(all_charts_data['model_eval_chart_data']);
    //Not showing AUC
    // let param = ['fscore', 'Recall', 'accuracy', 'Precision', 'auc', 'Xscore'];
    let param = ['fscore', 'Recall', 'accuracy', 'Precision', 'Xscore'];
    let param_val = [[], [], [], [], []];
    let bar_color=['#0B6623', '#708238', '#29AB87', '#004B49', '#1C352D']

    algos.forEach(function(algo) {
        param_val[0].push(all_charts_data['model_eval_chart_data'][algo][0])
        param_val[1].push(all_charts_data['model_eval_chart_data'][algo][1])
        param_val[2].push(all_charts_data['model_eval_chart_data'][algo][2])
        param_val[3].push(all_charts_data['model_eval_chart_data'][algo][3])
        param_val[4].push(all_charts_data['model_eval_chart_data'][algo][4])
    });

    for(let i=0;i<param.length;i++){
        data.push({
            x: algos,
            y: param_val[i],
            name: param[i],
            type: 'bar',
            marker: {
                color: bar_color[i],
            }
        })
    }

    console.log(data);

    layout = {
        autosize: true,
        title: 'Model Comparison Chart',
        xaxis: {
            title: 'Models',
            tickangle: 15,
        },
        yaxis: {
            title: '%'
        },
        width:1500,
        height: 700,
        barmode: 'group',
    };

    Plotly.newPlot('model-evaluation-chart', data, layout);

    // Chart: Actual Predicted Data

    data = [
        {
            z: [all_charts_data['actual_predicted_chart_data'][0],all_charts_data['actual_predicted_chart_data'][1]],
            type: 'heatmap',
            colorscale: [
                [0, '#3D9970'],
                [1, '#001f3f']
            ]
        }
    ];

    layout = {
        autosize: true,
        width:"100%",
        title: 'Actual Predicted Chart',
        xaxis: {
            title: 'Predicted label'
        },
        yaxis: {
            title: 'Actual label'
        },
        width: 700,
        height: 500,
    };

    Plotly.newPlot('actual-predicted-chart', data, layout);

    // Recovery rate chart 

    data = [{
        x: all_charts_data['recovery_rate_chart_data'],
        type: 'histogram',
        marker: {
            color: '#001F3F' // Set color of bars
        },
        nbinsx: 25
    }];

    layout = {
        autosize: true,
        title: 'Recovery Rate Chart',
        xaxis: {
            title: 'Recovery %',
        },
        yaxis: {
            title: 'Funded amount'
        },
        width: 700,
        height: 500,
    };

    Plotly.newPlot('recovery-rate-chart', data, layout);

    // CCF chart 

    data = [{
        x: all_charts_data['ccf_chart_data'],
        type: 'histogram',
        marker: {
            color: '#001F3F' // Set color of bars
        },
        nbinsx: 100
    }];

    layout = {
        autosize: true,
        title: 'CCF Chart',
        xaxis: {
            title: 'Value',
        },
        yaxis: {
            title: 'Frequency'
        },
        width: 700,
        height: 500,
    };

    Plotly.newPlot('ccf-chart', data, layout);

    // ROC chart

    // data for line chart
    trace1 = {
        x: all_charts_data['auroc_chart_data']['line_plot'][0],
        y: all_charts_data['auroc_chart_data']['line_plot'][1],
        type: 'line'
    };

    // data for scatter chart
    trace2 = {
        x: all_charts_data['auroc_chart_data']['dash_plot'][0],
        y: all_charts_data['auroc_chart_data']['dash_plot'][1],
        type: 'scatter',
        mode: 'markers'
    };

    layout = {
        autosize: true,
        title: 'ROC',
        xaxis: {
            title: 'False positive rate'
        },
        yaxis: {
            title: 'True positive rate'
        },
        width: 700,
        height: 500,
    };

    data = [trace1, trace2];
    Plotly.newPlot('roc-chart', data, layout);

    // Gini chart

    // data for line chart
    trace1 = {
        x: all_charts_data['gini_chart_data']['line_plot'][0],
        y: all_charts_data['gini_chart_data']['line_plot'][1],
        type: 'line'
    };

    // data for scatter chart
    trace2 = {
        x: all_charts_data['gini_chart_data']['dash_plot'][0],
        y: all_charts_data['gini_chart_data']['dash_plot'][1],
        type: 'scatter',
        mode: 'markers'
    };

    layout = {
        autosize: true,
        title: 'Gini',
        xaxis: {
            title: 'Cumulative % Population'
        },
        yaxis: {
            title: 'Cumulative % Bad'
        },
        width: 700,
        height: 500,
    };

    data = [trace1, trace2];
    Plotly.newPlot('gini-chart', data, layout);


    // Smirnov Chart

    // data for line chart
    trace1 = {
        x: all_charts_data['smirnov_chart_data']['red_plot'][0],
        y: all_charts_data['smirnov_chart_data']['red_plot'][1],
        type: 'line',
        line: {
            color: 'red' // Set color of bars
        },
    };

    // data for scatter chart
    trace2 = {
        x: all_charts_data['smirnov_chart_data']['blue_plot'][0],
        y: all_charts_data['smirnov_chart_data']['blue_plot'][1],
        type: 'line',
        line: {
            color: 'blue' // Set color of bars
        },
    };

    layout = {
        autosize: true,
        title: 'Kolmogorov-Smirnov',
        xaxis: {
            title: 'Estimated Probability for being Good'
        },
        yaxis: {
            title: 'Cumulative %'
        },
        width: 700,
        height: 500,
    };

    data = [trace1, trace2];
    Plotly.newPlot('smirnov-chart', data, layout);

    "{% endif %}"
    });
    

    
</script>

{%endblock%}